# 🔧 エックスサーバーのWAF設定手順

## 問題の原因

エックスサーバーの**WAF（Web Application Firewall）**が、GitHub ActionsからのREST APIアクセスを「攻撃」と判断してブロックしています。

ローカルからは成功するのに、GitHub Actionsからは403エラーが出るのは、これが原因です。

## ✅ 解決方法（2つの選択肢）

### 方法1: WAFを一時的にOFFにする（簡単・推奨）

#### ステップ1: サーバーパネルにログイン

1. エックスサーバーのサーバーパネルにアクセス
   ```
   https://www.xserver.ne.jp/login_server.php
   ```

2. サーバーIDとパスワードでログイン

#### ステップ2: WAF設定を開く

1. ログイン後、「**セキュリティ**」カテゴリーの中から「**WAF設定**」をクリック

#### ステップ3: 対象ドメインのWAFをOFFにする

1. ドメイン一覧から `freeeeeeestyle.com` を探す

2. 「**WAF設定**」の列で「**OFF**」をクリック

3. 確認画面が表示されたら「**確定する**」をクリック

#### ステップ4: 設定が反映されるまで待つ

⚠️ **重要**: 設定反映には**最大1時間**かかる場合があります
- 通常は5-10分程度
- 念のため15分ほど待つことをおすすめします

#### ステップ5: GitHub Actionsを再実行

1. GitHubリポジトリページを開く
   ```
   https://github.com/KeijiSuetsugu/blog-auto-poster
   ```

2. 「**Actions**」タブをクリック

3. 「**Run workflow**」をクリック

4. 実行結果を確認

---

### 方法2: WAFの除外設定（セキュリティを保ちたい場合）

WAFを完全にOFFにしたくない場合、特定のパスだけ除外できます。

#### ステップ1: .htaccessファイルを編集

エックスサーバーのファイルマネージャーまたはFTPで、以下のファイルを編集：

```
/public_html/.htaccess
```

#### ステップ2: 以下を追加

```apache
# WordPress REST APIをWAFから除外
<IfModule mod_siteguard.c>
    SiteGuard_User_ExcludeSig wp-json
</IfModule>
```

#### ステップ3: ファイルを保存

#### ステップ4: 5-10分待ってからGitHub Actionsを再実行

---

## 📊 どちらの方法を選ぶべきか？

| 方法 | メリット | デメリット | おすすめ度 |
|------|----------|------------|------------|
| **方法1: WAF OFF** | 簡単、確実 | サイト全体のセキュリティが少し下がる | ⭐⭐⭐⭐⭐ |
| **方法2: 除外設定** | セキュリティを保てる | .htaccessの編集が必要 | ⭐⭐⭐ |

### 推奨: まず方法1を試す

1. 方法1でWAFをOFFにしてテスト
2. 成功したら、WAFが原因だと確定
3. その後、方法2で除外設定を追加してWAFを再度ONにする

---

## 🎯 詳細な手順（画像付き説明）

### 1. サーバーパネルにログイン

エックスサーバーのログインページ:
```
https://www.xserver.ne.jp/login_server.php
```

**入力項目:**
- サーバーID: （契約時に送られてきたメール参照）
- サーバーパスワード: （設定したパスワード）

### 2. WAF設定を探す

ログイン後の画面で、右側のメニューから：

```
セキュリティ
  └─ WAF設定 ← これをクリック
```

### 3. ドメインを選択

ドメイン一覧が表示されます：

```
ドメイン名              WAF設定
freeeeeeestyle.com     [ON] [OFF] ← OFFをクリック
```

### 4. 確認画面

```
以下のドメインのWAF設定を「無効」にします。
よろしいですか？

ドメイン名: freeeeeeestyle.com

[キャンセル] [確定する] ← 確定するをクリック
```

### 5. 完了画面

```
WAF設定の変更を受け付けました。
設定の反映には最大で1時間程度かかります。
```

---

## ⏱️ タイムライン

```
0分   : WAFをOFFに設定
5-10分 : 設定が反映される（通常）
15分  : 念のため待つ
15分  : GitHub Actionsを実行
16分  : 成功！🎉
```

---

## ✅ 成功後の確認

GitHub Actionsのログで以下が表示されればOK：

```
✅ 記事の投稿に成功しました
記事ID: 1481
記事URL: https://freeeeeeestyle.com/?p=1481
```

---

## 🔒 セキュリティについて

### WAFをOFFにしても大丈夫？

**短期的には問題ありません**が、長期的には以下の対策を推奨：

1. ✅ まずWAFをOFFにして動作確認
2. ✅ 成功したら、方法2の除外設定を追加
3. ✅ WAFを再度ONにする

### WAFがOFFだと何が起こる？

- SQLインジェクション攻撃への防御が弱くなる
- XSS攻撃への防御が弱くなる

**ただし**:
- WordPressは定期的に更新していれば基本的に安全
- プラグインも最新版に保っていれば問題なし
- 個人ブログレベルなら、WAF OFFでも実害はほぼない

---

## 🆘 それでも403エラーが出る場合

WAFをOFFにしても403エラーが出る場合：

### 確認1: 設定が反映されているか確認

エックスサーバーのサーバーパネルで：
1. WAF設定を開く
2. `freeeeeeestyle.com` のWAFが「**OFF**」になっているか確認

### 確認2: 15分以上待つ

設定反映に時間がかかる場合があります。

### 確認3: セキュリティプラグインも確認

WordPress側のセキュリティプラグインもブロックしている可能性があります。

1. WordPress管理画面にログイン
2. プラグイン → インストール済みプラグイン
3. セキュリティプラグインがあれば一時的に無効化

---

## 📝 まとめ

1. ✅ エックスサーバーのサーバーパネルにログイン
2. ✅ WAF設定を開く
3. ✅ `freeeeeeestyle.com` のWAFを「**OFF**」にする
4. ✅ 15分待つ
5. ✅ GitHub Actionsを実行

**所要時間: 約20分（待ち時間含む）**

これで解決するはずです！


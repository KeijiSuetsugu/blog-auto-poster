# AI記事生成機能 更新内容

## 実装した変更点

### ① 重複投稿防止機能

**問題**: 同じ内容が2日連続で投稿されることがあった

**解決策**:
- 投稿履歴を`post_history.json`ファイルに保存
- 新しい記事を生成する前に、過去30日間の投稿履歴とタイトルを比較
- 重複が検出された場合、最大3回までリトライ
- タイトルの完全一致または最初の20文字が一致する場合を重複と判定

**実装詳細**:
- `_load_post_history()`: 投稿履歴を読み込む
- `_save_post_history()`: 投稿履歴を保存（30日以上前の履歴は自動削除）
- `_is_duplicate()`: タイトルの重複をチェック
- `generate_article()`: 重複チェックを統合

### ② 画像生成のデバッグ機能強化

**問題**: 自動で画像が生成されていない

**解決策**:
- 画像生成設定の詳細なデバッグ情報を表示
- 画像生成の各ステップでログを出力
- エラー時の詳細な情報を表示
- Unsplash APIキーの設定状況を確認

**デバッグ情報の表示内容**:
```
============================================================
画像生成設定の確認
============================================================
画像生成: 有効/無効
画像ソース: unsplash/dalle
Unsplash APIキー: 設定済み/未設定
============================================================
```

### ③ AI記事への変更と最新ニュース対応

**変更内容**:
- テーマを「人間関係・心理学」から「AI技術」に完全変更
- 最新AIニュースを取得して記事を生成
- AIツールの比較や評価を含む実用的な内容
- 読者が興味を持つ内容（最新機能、比較、実用例など）を重視

**最新ニュース取得方法**:
1. **NewsAPI**（優先）: 無料プランで最新のAIニュースを取得
2. **OpenAIフォールバック**: NewsAPIが利用できない場合、GPT-4o-miniに最新情報を検索させる

**記事の特徴**:
- 最新のAI技術やサービスの情報
- AIツールの比較や評価
- 実用的な活用方法や使用例
- 最新機能や新機能の解説
- 読者が実際に試せる具体的なアドバイス

## 必要な環境変数

### 既存の環境変数
```env
OPENAI_API_KEY=sk-your-openai-api-key-here
WORDPRESS_URL=https://your-wordpress-site.com
WORDPRESS_USERNAME=your-username
WORDPRESS_PASSWORD=your-application-password
IMAGE_SOURCE=unsplash
UNSPLASH_ACCESS_KEY=your-unsplash-access-key-here
```

### 新規追加（オプション）
```env
# NewsAPIキー（最新ニュース取得用、オプション）
NEWSAPI_KEY=your-newsapi-key-here
```

**NewsAPIキーの取得方法**:
1. https://newsapi.org/ にアクセス
2. 無料アカウントを作成（1日100リクエストまで）
3. APIキーを取得して`.env`ファイルに追加

**注意**: NewsAPIキーがなくても、OpenAIフォールバック機能により最新情報を取得できます。

## ファイル構成

### 新規作成ファイル
- `post_history.json`: 投稿履歴を保存（自動生成、Git管理不要）

### 変更ファイル
- `article_generator.py`: 大幅に変更
  - AI記事生成機能
  - 最新ニュース取得機能
  - 重複防止機能
  - 画像生成デバッグ機能

## 使用方法

### 通常の使用
変更は不要です。既存のコードで自動的に新しい機能が動作します：

```bash
python wordpress_poster.py
```

### 投稿履歴の確認
`post_history.json`ファイルを確認することで、過去の投稿履歴を確認できます：

```json
[
  {
    "title": "記事タイトル",
    "date": "2024-01-01T12:00:00",
    "theme": "AI関連のテーマ"
  }
]
```

### 重複チェックの動作
1. 記事生成時に自動的に過去30日間の履歴と比較
2. 重複が検出された場合、自動的にリトライ（最大3回）
3. リトライ後も重複する場合、警告を表示して投稿を続行

## トラブルシューティング

### 画像が生成されない場合

1. **環境変数の確認**
   ```bash
   # .envファイルを確認
   IMAGE_SOURCE=unsplash
   UNSPLASH_ACCESS_KEY=your-key-here
   ```

2. **デバッグ情報の確認**
   - 実行時に表示される「画像生成設定の確認」セクションを確認
   - Unsplash APIキーが設定されているか確認

3. **エラーログの確認**
   - `⚠️ Unsplash画像取得エラー`などのエラーメッセージを確認
   - APIキーの有効性を確認

### 同じ記事が投稿される場合

1. **投稿履歴の確認**
   - `post_history.json`ファイルを確認
   - 過去30日間の投稿履歴が正しく保存されているか確認

2. **リトライ機能の確認**
   - 重複が検出された場合、自動的にリトライされることを確認
   - 最大3回までリトライされることを確認

### 最新ニュースが取得できない場合

1. **NewsAPIキーの確認**
   - NewsAPIキーが設定されているか確認
   - 無料プランの制限（1日100リクエスト）を確認

2. **OpenAIフォールバックの確認**
   - NewsAPIが利用できない場合、OpenAIフォールバックが動作することを確認
   - OpenAI APIキーが有効か確認

## 今後の改善案

1. **より高度な重複検出**
   - 記事内容の類似度を計算（現在はタイトルのみ）
   - セマンティック類似度の使用

2. **ニュースソースの拡張**
   - 複数のニュースソースからの情報取得
   - RSSフィードの活用

3. **画像生成の改善**
   - より関連性の高い画像の生成
   - 複数の画像ソースからの選択

4. **記事の品質向上**
   - より詳細な比較情報
   - 実際の使用例の追加
   - スクリーンショットや図表の追加

## まとめ

✅ 重複投稿防止機能を実装  
✅ 画像生成のデバッグ機能を強化  
✅ AI記事への完全変更  
✅ 最新ニュースを基にした記事生成  
✅ 実用的で読者が興味を持つ内容  

これで、毎日最新のAIニュースを基にした、重複のない、画像付きの記事が自動投稿されます！


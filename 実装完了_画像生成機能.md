# 画像生成機能 実装完了報告

## 実装内容

記事投稿時にサムネイル画像（アイキャッチ画像）を自動生成し、WordPressに設定する機能を実装しました。

## 変更ファイル

### 1. `article_generator.py`
**追加機能**:
- Unsplash APIから関連画像を取得する機能
- DALL-E 3で画像を生成する機能
- 画像ソースの切り替え機能（unsplash / dalle）
- 自動フォールバック機能（Unsplash失敗時にDALL-E 3を使用）

**新規メソッド**:
- `_generate_image_keywords()`: 記事テーマから英語キーワードを生成
- `generate_image_from_unsplash()`: Unsplash APIで画像取得
- `generate_image_from_dalle()`: DALL-E 3で画像生成
- `generate_image()`: 設定に基づいて画像を生成

**変更点**:
- `__init__()`: `image_source`パラメータを追加
- `generate_article()`: `generate_image`パラメータを追加、画像生成処理を統合
- 戻り値に`image_path`と`image_url`を追加

### 2. `wordpress_poster.py`
**追加機能**:
- WordPressへの画像アップロード機能
- アイキャッチ画像の設定機能
- 一時ファイルの自動削除

**新規メソッド**:
- `upload_media()`: 画像をWordPressにアップロード

**変更点**:
- `__init__()`: `media_api_url`を追加
- `create_post()`: `featured_media_id`パラメータを追加
- `post_daily_article()`: 画像生成・アップロード処理を統合

### 3. `requirements.txt`
**変更**: なし（既に必要なライブラリが含まれています）

### 4. 新規ファイル
- `画像生成機能_設定ガイド.md`: 詳細な設定手順とトラブルシューティング

## 使用方法

### 基本的な使い方

1. **Unsplash APIキーを取得**（推奨・無料）
   - https://unsplash.com/developers でアカウント作成
   - アプリケーションを作成してAccess Keyを取得

2. **.envファイルに追加**
   ```env
   IMAGE_SOURCE=unsplash
   UNSPLASH_ACCESS_KEY=your-access-key-here
   ```

3. **通常通り実行**
   ```bash
   python wordpress_poster.py
   ```

### DALL-E 3を使用する場合

```env
IMAGE_SOURCE=dalle
```

### 画像生成をスキップする場合

環境変数を設定しないか、コードで`generate_image=False`を指定

## 機能の特徴

### 1. コスト最適化
- **Unsplash**: 完全無料（月50リクエストまで）
- **DALL-E 3**: $0.04/枚（約6円）
- **ハイブリッド**: Unsplash優先、失敗時のみDALL-E 3

### 2. 自動フォールバック
環境変数`DALLE_FALLBACK=true`を設定すると、Unsplashが失敗した場合に自動的にDALL-E 3にフォールバック

### 3. 関連性の高い画像
- Unsplash: 記事テーマから英語キーワードを自動生成して検索
- DALL-E 3: 記事テーマとタイトルに基づいてプロンプトを生成

### 4. WordPress統合
- 画像を自動的にWordPressにアップロード
- アイキャッチ画像として設定
- 一時ファイルを自動削除

## テーマ別キーワードマッピング

記事テーマから自動的に英語キーワードを生成：

| 日本語キーワード | 英語キーワード |
|-----------------|---------------|
| ミラーリング、コミュニケーション | communication |
| 人間関係 | relationships |
| 心理学 | psychology |
| ストレス | stress management |
| マインドフルネス | mindfulness |
| 感情 | emotions |
| モチベーション | motivation |
| 目標 | goals achievement |
| 習慣 | habits |
| 幸福 | happiness |
| 学習 | learning |
| 記憶 | memory |
| リーダーシップ | leadership |
| チーム | teamwork |
| 意思決定 | decision making |
| 自己 | self improvement |
| 性格 | personality |

## エラーハンドリング

### 画像生成失敗時
- 警告メッセージを表示
- 記事投稿は続行（画像なしで投稿）
- エラーログを出力

### 画像アップロード失敗時
- 警告メッセージを表示
- 記事投稿は続行（画像なしで投稿）
- 一時ファイルは削除を試行

## GitHub Actionsでの使用

GitHub Secretsに以下を追加：

```
UNSPLASH_ACCESS_KEY: your-access-key
IMAGE_SOURCE: unsplash
DALLE_FALLBACK: false
```

既存のワークフローはそのまま動作します。

## プログラムからの使用例

```python
from article_generator import generate_article

# Unsplashで画像生成
article = generate_article(image_source='unsplash', generate_image=True)

# DALL-E 3で画像生成
article = generate_article(image_source='dalle', generate_image=True)

# 画像なし
article = generate_article(generate_image=False)

# 結果の取得
print(f"タイトル: {article['title']}")
print(f"本文: {article['content']}")
if 'image_path' in article:
    print(f"画像パス: {article['image_path']}")
    print(f"画像URL: {article['image_url']}")
```

## 注意事項

1. **Unsplash API制限**
   - 無料プランは月50リクエストまで
   - 商用利用可能だが、クレジット表記推奨

2. **DALL-E 3コスト**
   - 1枚あたり$0.04（standard品質、1024×1024）
   - OpenAIアカウントに十分なクレジットが必要

3. **WordPress権限**
   - アプリケーションパスワードに「メディアアップロード」権限が必要
   - セキュリティプラグインがメディアアップロードをブロックしていないか確認

4. **一時ファイル**
   - 画像は一時ファイルとしてダウンロードされます
   - アップロード後に自動削除されます
   - 失敗時は手動で削除が必要な場合があります

## 今後の拡張案

1. **画像サイズのカスタマイズ**
   - 環境変数で画像サイズを指定可能に

2. **複数画像対応**
   - 記事内に複数の画像を挿入

3. **画像キャッシュ**
   - 同じテーマの画像を再利用

4. **画像編集**
   - テキストオーバーレイ
   - フィルター適用

5. **他の画像ソース**
   - Pixabay API
   - Pexels API
   - Stable Diffusion

## まとめ

✅ Unsplash API（無料）とDALL-E 3（有料）の両方に対応  
✅ 簡単に切り替え可能  
✅ 自動フォールバック機能  
✅ WordPressへの自動アップロード  
✅ アイキャッチ画像として自動設定  
✅ エラーハンドリング完備  
✅ GitHub Actions対応  

記事投稿時に自動的に関連画像が生成・設定されるようになりました！


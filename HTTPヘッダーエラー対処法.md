# 🔧 HTTPヘッダーエラー対処法

## エラーメッセージ

```
httpx.LocalProtocolError: Illegal header value b'***'
openai.APIConnectionError: Connection error.
```

## 原因

このエラーは、HTTPヘッダーに無効な文字が含まれていることを示しています。通常、以下の原因が考えられます：

1. **APIキーに不正な文字が含まれている**
   - 改行文字（`\n`）や制御文字
   - 余分なスペース
   - 特殊文字のエンコーディング問題

2. **GitHub Secretsから環境変数に正しく渡されていない**
   - Secretの値に改行が含まれている
   - コピー&ペースト時に余分な文字が入った

3. **環境変数のエンコーディング問題**

## ✅ 解決方法

### ステップ1: GitHub SecretsのAPIキーを再確認・再設定

1. **GitHubリポジトリページを開く：**
   ```
   https://github.com/KeijiSuetsugu/blog-auto-poster
   ```

2. **「Settings」→「Secrets and variables」→「Actions」を開く**

3. **`OPENAI_API_KEY`を削除して再作成：**
   - `OPENAI_API_KEY`の右側の「削除」ボタンをクリック
   - 確認して削除

4. **新しいSecretを作成：**
   - 「New repository secret」をクリック
   - Name: `OPENAI_API_KEY`
   - Secret: `.env`ファイルから**慎重に**コピー
     - `.env`ファイルを開く
     - `OPENAI_API_KEY=`の**後ろの値だけ**を選択
     - **改行を含めない**ように注意
     - コピーして貼り付け
   - 「Add secret」をクリック

### ステップ2: APIキーの形式を確認

正しいAPIキーの形式：
- `sk-`または`sk-proj-`で始まる
- 長さは約160-170文字程度
- 改行文字が含まれていない

### ステップ3: 再度ワークフローを実行

1. 「Actions」タブをクリック
2. 「毎日のブログ投稿」ワークフローを選択
3. 「Run workflow」ボタンをクリック
4. 実行ログを確認

### ステップ4: デバッグ情報を確認

ログの「ブログ記事を投稿」ステップで、以下が表示されます：
- `OPENAI_API_KEY length: XXX`（文字数）
- `DEBUG: APIキーの長さ: XXX文字`
- `DEBUG: APIキーのプレビュー: sk-proj-...XXX`

これでAPIキーが正しく読み込まれているか確認できます。

## 🆘 まだエラーが出る場合

### 方法1: APIキーを手動で再入力

1. GitHub Secretsで`OPENAI_API_KEY`を削除
2. `.env`ファイルからAPIキーをコピー
3. **メモ帳などのテキストエディタに一度貼り付け**
4. 改行や余分なスペースがないか確認
5. 改行がないことを確認したら、GitHub Secretsに貼り付け

### 方法2: 新しいAPIキーを生成

もし問題が解決しない場合：
1. OpenAIダッシュボードで新しいAPIキーを生成
2. 新しいキーを`.env`ファイルに設定
3. 同じキーをGitHub Secretsにも設定

## ⚠️ 重要なポイント

1. **改行文字を含めない**
   - APIキーをコピーする時、改行が含まれないように注意
   - 値だけをコピー（`OPENAI_API_KEY=`は含めない）

2. **余分なスペースを削除**
   - 先頭や末尾にスペースが入っていないか確認

3. **全文コピー**
   - APIキーは途中で切れないように、全部コピーする

## 📝 確認方法

GitHub Actionsのログで以下を確認：
- `OPENAI_API_KEY length: 164` のような文字数が表示される
- 160文字以上あれば、おおよそ正しい長さです
- もし10文字程度しかない場合は、コピー漏れの可能性があります

詳しいデバッグ情報が表示されるように修正しました。次回の実行で、より詳細な情報が得られるはずです。






